---
apiVersion: v1
kind: ConfigMap
metadata:
  name: populate-oom-db-script
  namespace: cruisekube-system
data:
  populate.sql: |
    INSERT INTO stats (cluster_id, workload_id, stats, generated_at, overrides)
    VALUES (
        'default',
        'Deployment:test-oom:stress-deployment',
        '{
          "workload": "Deployment:test-oom:stress-deployment",
          "kind": "Deployment",
          "namespace": "test-oom",
          "name": "stress-deployment",
          "creation_time": "2024-01-01T00:00:00Z",
          "continuous_optimization": true,
          "is_horizontally_autoscaled_on_cpu": false,
          "eviction_ranking": 2,
          "replicas": 1,
          "container_stats": [
            {
              "container_name": "stress",
              "container_type": 3,
              "cpu_stats": {
                "max": 0.2,
                "p50": 0.1,
                "p75": 0.15
              },
              "memory_stats": {
                "max": 40.0,
                "p75": 30.0,
                "oom_memory": 0.0
              },
              "memory_7day": {
                "max": 45.0
              },
              "cpu_7day": {
                "max": 0.25,
                "p50": 0.1,
                "p75": 0.15,
                "p90": 0.18,
                "p99": 0.22
              },
              "simple_predictions_cpu": {
                "weekly_prediction": 0.15,
                "hourly_prediction": 0.12,
                "current_prediction": 0.1,
                "max_value": 0.2
              },
              "simple_predictions_memory": {
                "weekly_prediction": 35.0,
                "hourly_prediction": 32.0,
                "current_prediction": 30.0,
                "max_value": 40.0
              }
            }
          ],
          "original_container_resources": [
            {
              "name": "stress",
              "type": 3,
              "cpu_request": 0.1,
              "cpu_limit": 0.2,
              "memory_request": 30.0,
              "memory_limit": 50.0
            }
          ]
        }',
        NOW() - INTERVAL '1 hour',
        NULL
    );

    SELECT workload_id FROM stats WHERE workload_id = 'Deployment:test-oom:stress-deployment';
---
apiVersion: batch/v1
kind: Job
metadata:
  name: populate-oom-db
  namespace: cruisekube-system
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: populate-db
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "Waiting for postgres to be ready..."
          until pg_isready -h cruisekube-postgresql.cruisekube-system.svc.cluster.local -U cruisekube; do
            sleep 2
          done
          echo "Postgres is ready. Populating database..."
          psql -h cruisekube-postgresql.cruisekube-system.svc.cluster.local -U cruisekube -d cruisekube -f /scripts/populate.sql
          echo "Database populated successfully!"
        env:
        - name: PGPASSWORD
          value: cruisekube
        volumeMounts:
        - name: scripts
          mountPath: /scripts
      volumes:
      - name: scripts
        configMap:
          name: populate-oom-db-script
