---
apiVersion: v1
kind: ConfigMap
metadata:
  name: populate-webhook-db-script
  namespace: cruisekube-system
data:
  populate.sql: |
    INSERT INTO stats (cluster_id, workload_id, stats, generated_at, overrides)
    VALUES (
        'default',
        'Deployment:test-webhook:redis-deployment',
        '{
          "workload": "Deployment:test-webhook:redis-deployment",
          "kind": "Deployment",
          "namespace": "test-webhook",
          "name": "redis-deployment",
          "creation_time": "2024-01-01T00:00:00Z",
          "continuous_optimization": true,
          "is_horizontally_autoscaled_on_cpu": false,
          "eviction_ranking": 2,
          "replicas": 2,
          "container_stats": [
            {
              "container_name": "redis",
              "container_type": 3,
              "cpu_stats": {
                "max": 0.5,
                "p50": 0.2,
                "p75": 0.3
              },
              "memory_stats": {
                "max": 200.0,
                "p75": 150.0,
                "oom_memory": 0.0
              },
              "memory_7day": {
                "max": 220.0
              },
              "cpu_7day": {
                "max": 0.6,
                "p50": 0.2,
                "p75": 0.3,
                "p90": 0.45,
                "p99": 0.55
              },
              "simple_predictions_cpu": {
                "weekly_prediction": 0.35,
                "hourly_prediction": 0.3,
                "current_prediction": 0.25,
                "max_value": 0.5
              },
              "simple_predictions_memory": {
                "weekly_prediction": 180.0,
                "hourly_prediction": 170.0,
                "current_prediction": 160.0,
                "max_value": 200.0
              }
            }
          ],
          "original_container_resources": [
            {
              "name": "redis",
              "type": 3,
              "cpu_request": 0.1,
              "cpu_limit": 0.2,
              "memory_request": 64.0,
              "memory_limit": 128.0
            }
          ]
        }',
        NOW() - INTERVAL '1 hour',
        NULL
    );

    INSERT INTO stats (cluster_id, workload_id, stats, generated_at, overrides)
    VALUES (
        'default',
        'Deployment:test-webhook:memcached-deployment',
        '{
          "workload": "Deployment:test-webhook:memcached-deployment",
          "kind": "Deployment",
          "namespace": "test-webhook",
          "name": "memcached-deployment",
          "creation_time": "2024-01-01T00:00:00Z",
          "continuous_optimization": true,
          "is_horizontally_autoscaled_on_cpu": false,
          "eviction_ranking": 2,
          "replicas": 1,
          "container_stats": [
            {
              "container_name": "memcached",
              "container_type": 3,
              "cpu_stats": {
                "max": 0.25,
                "p50": 0.08,
                "p75": 0.12
              },
              "memory_stats": {
                "max": 80.0,
                "p75": 60.0,
                "oom_memory": 0.0
              },
              "memory_7day": {
                "max": 90.0
              },
              "cpu_7day": {
                "max": 0.3,
                "p50": 0.08,
                "p75": 0.12,
                "p90": 0.2,
                "p99": 0.28
              },
              "simple_predictions_cpu": {
                "weekly_prediction": 0.15,
                "hourly_prediction": 0.12,
                "current_prediction": 0.1,
                "max_value": 0.25
              },
              "simple_predictions_memory": {
                "weekly_prediction": 70.0,
                "hourly_prediction": 65.0,
                "current_prediction": 60.0,
                "max_value": 80.0
              }
            }
          ],
          "original_container_resources": [
            {
              "name": "memcached",
              "type": 3,
              "cpu_request": 0.05,
              "cpu_limit": 0.1,
              "memory_request": 32.0,
              "memory_limit": 64.0
            }
          ]
        }',
        NOW() - INTERVAL '1 hour',
        NULL
    );

    SELECT workload_id FROM stats WHERE workload_id LIKE '%test-webhook%';
---
apiVersion: batch/v1
kind: Job
metadata:
  name: populate-webhook-db
  namespace: cruisekube-system
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: populate-db
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "Waiting for postgres to be ready..."
          until pg_isready -h cruisekube-postgresql.cruisekube-system.svc.cluster.local -U cruisekube; do
            sleep 2
          done
          echo "Postgres is ready. Populating database..."
          psql -h cruisekube-postgresql.cruisekube-system.svc.cluster.local -U cruisekube -d cruisekube -f /scripts/populate.sql
          echo "Database populated successfully!"
        env:
        - name: PGPASSWORD
          value: cruisekube
        volumeMounts:
        - name: scripts
          mountPath: /scripts
      volumes:
      - name: scripts
        configMap:
          name: populate-webhook-db-script
